<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöå –°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞—Å—Å–∞–∂–∏—Ä–æ–ø–æ—Ç–æ–∫–æ–º</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-top: 20px;
        }
        .card {
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: none;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }
        .table th {
            background: linear-gradient(135deg, #495057, #6c757d);
            color: white;
            border: none;
        }
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        .header-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
        }
        .load-indicator {
            height: 8px;
            border-radius: 4px;
            margin-top: 5px;
        }
        .load-low { background: #28a745; }
        .load-medium { background: #ffc107; }
        .load-high { background: #dc3545; }
        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–∏—Å—Ç–µ–º—ã -->
        <div class="text-center mb-4">
            <h1 class="text-white"><i class="fas fa-bus me-2"></i>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞—Å—Å–∞–∂–∏—Ä–æ–ø–æ—Ç–æ–∫–æ–º</h1>
            <p class="text-white-50">–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏ –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞</p>
        </div>

        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏ -->
        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="passengers-tab" data-bs-toggle="tab" 
                        data-bs-target="#passengers" type="button" role="tab">
                    <i class="fas fa-users me-1"></i>–ü–∞—Å—Å–∞–∂–∏—Ä–æ–ø–æ—Ç–æ–∫
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="predictions-tab" data-bs-toggle="tab" 
                        data-bs-target="#predictions" type="button" role="tab">
                    <i class="fas fa-chart-line me-1"></i>–ü—Ä–æ–≥–Ω–æ–∑—ã
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="stops-tab" data-bs-toggle="tab" 
                        data-bs-target="#stops" type="button" role="tab">
                    <i class="fas fa-map-marker-alt me-1"></i>–û—Å—Ç–∞–Ω–æ–≤–∫–∏
                </button>
            </li>
        </ul>

        <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∫–ª–∞–¥–æ–∫ -->
        <div class="tab-content">
            <!-- –í–∫–ª–∞–¥–∫–∞ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–ø–æ—Ç–æ–∫–∞ -->
            <div class="tab-pane fade show active" id="passengers" role="tabpanel">
                <div class="card p-4">
                    <div class="header-actions">
                        <h3 class="mb-0"><i class="fas fa-users me-2"></i>–£—á–µ—Ç –ø–∞—Å—Å–∞–∂–∏—Ä–æ–ø–æ—Ç–æ–∫–∞</h3>
                        <button class="btn btn-success" onclick="addPassengerCount()">
                            <i class="fas fa-plus me-1"></i>–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å
                        </button>
                    </div>

                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h5><i class="fas fa-sign-in-alt me-2"></i>–í—Å–µ–≥–æ –≤–æ—à–ª–æ</h5>
                                <h3 id="totalEntered">0</h3>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h5><i class="fas fa-sign-out-alt me-2"></i>–í—Å–µ–≥–æ –≤—ã—à–ª–æ</h5>
                                <h3 id="totalExited">0</h3>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h5><i class="fas fa-exchange-alt me-2"></i>–ß–∏—Å—Ç—ã–π –ø–æ—Ç–æ–∫</h5>
                                <h3 id="netPassengers">0</h3>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <h5><i class="fas fa-chart-bar me-2"></i>–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</h5>
                                <h3 id="totalRecords">0</h3>
                            </div>
                        </div>
                    </div>

                    <!-- –¢–∞–±–ª–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>–ê–≤—Ç–æ–±—É—Å</th>
                                    <th>–û—Å—Ç–∞–Ω–æ–≤–∫–∞</th>
                                    <th>–í–æ—à–ª–æ</th>
                                    <th>–í—ã—à–ª–æ</th>
                                    <th>–í—Ä–µ–º—è</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="passengerTableBody">
                                <!-- –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- –í–∫–ª–∞–¥–∫–∞ –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ -->
            <div class="tab-pane fade" id="predictions" role="tabpanel">
                <div class="card p-4">
                    <h3 class="mb-4"><i class="fas fa-chart-line me-2"></i>–ü—Ä–æ–≥–Ω–æ–∑—ã –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏</h3>
                    
                    <!-- –§–æ—Ä–º–∞ –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–∞ -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label class="form-label">–ú–∞—Ä—à—Ä—É—Ç</label>
                            <select id="routeSelect" class="form-select">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">–í—Ä–µ–º—è</label>
                            <input type="time" id="predictionTime" class="form-control" value="15:00">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-primary w-100" onclick="getPrediction()">
                                <i class="fas fa-calculator me-1"></i>–†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø—Ä–æ–≥–Ω–æ–∑
                            </button>
                        </div>
                    </div>

                    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≥–Ω–æ–∑–∞ -->
                    <div id="predictionResult" class="d-none">
                        <div class="alert alert-info">
                            <h5><i class="fas fa-info-circle me-2"></i>–ü—Ä–æ–≥–Ω–æ–∑ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏</h5>
                            <div class="mt-2">
                                <strong>–ú–∞—Ä—à—Ä—É—Ç:</strong> <span id="predRoute"></span><br>
                                <strong>–í—Ä–µ–º—è:</strong> <span id="predTime"></span><br>
                                <strong>–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å:</strong> <span id="predLoad"></span>%
                                <div class="load-indicator" id="loadIndicator"></div>
                            </div>
                        </div>
                    </div>

                    <!-- –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –ø—Ä–æ–≥–Ω–æ–∑—ã -->
                    <div class="mt-4">
                        <h5>–ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –≤–µ—Å—å –¥–µ–Ω—å</h5>
                        <button class="btn btn-outline-primary mb-3" onclick="getDailyPredictions()">
                            <i class="fas fa-calendar-alt me-1"></i>–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑
                        </button>
                        <div id="dailyPredictions"></div>
                    </div>
                </div>
            </div>

            <!-- –í–∫–ª–∞–¥–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫ -->
            <div class="tab-pane fade" id="stops" role="tabpanel">
                <div class="card p-4">
                    <div class="header-actions">
                        <h3 class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞–º–∏</h3>
                        <button class="btn btn-success" onclick="addStop()">
                            <i class="fas fa-plus me-1"></i>–î–æ–±–∞–≤–∏—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–∫—É
                        </button>
                    </div>

                    <!-- –ü–æ–∏—Å–∫ –±–ª–∏–∂–∞–π—à–∏—Ö –æ—Å—Ç–∞–Ω–æ–≤–æ–∫ -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <h5><i class="fas fa-search-location me-2"></i>–ü–æ–∏—Å–∫ –±–ª–∏–∂–∞–π—à–∏—Ö –æ—Å—Ç–∞–Ω–æ–≤–æ–∫</h5>
                            <div class="row g-3 align-items-end">
                                <div class="col-md-3">
                                    <label class="form-label">–®–∏—Ä–æ—Ç–∞</label>
                                    <input type="number" id="searchLat" class="form-control" placeholder="55.7558" step="0.0001">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">–î–æ–ª–≥–æ—Ç–∞</label>
                                    <input type="number" id="searchLon" class="form-control" placeholder="37.6173" step="0.0001">
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-primary w-100" onclick="findNearbyStops()">
                                        <i class="fas fa-search me-1"></i>–ù–∞–π—Ç–∏
                                    </button>
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-secondary w-100" onclick="useCurrentLocation()">
                                        <i class="fas fa-location-arrow me-1"></i>–ú–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- –¢–∞–±–ª–∏—Ü–∞ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫ -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                    <th>–®–∏—Ä–æ—Ç–∞</th>
                                    <th>–î–æ–ª–≥–æ—Ç–∞</th>
                                    <th>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="stopsTableBody">
                                <!-- –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–∞—Å—Å–∞–∂–∏—Ä–æ–ø–æ—Ç–æ–∫–æ–º
        let currentPassengerPage = 0;
        const pageSize = 10;

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –ø–∞—Å—Å–∞–∂–∏—Ä–∞—Ö
        function loadPassengerData() {
            fetch('/api/passengers')
                .then(response => {
                    if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
                    return response.json();
                })
                .then(data => {
                    const tbody = document.getElementById('passengerTableBody');
                    tbody.innerHTML = '';

                    let totalEntered = 0;
                    let totalExited = 0;

                    if (data && data.length > 0) {
                        data.forEach(passenger => {
                            totalEntered += passenger.entered;
                            totalExited += passenger.exited;
                            
                            const row = `
                                <tr>
                                    <td>${passenger.id}</td>
                                    <td>${passenger.bus ? `–ê–≤—Ç–æ–±—É—Å ${passenger.bus.id}` : '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                                    <td>${passenger.stop ? passenger.stop.name : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</td>
                                    <td><span class="badge bg-success">+${passenger.entered}</span></td>
                                    <td><span class="badge bg-danger">-${passenger.exited}</span></td>
                                    <td>${new Date(passenger.timestamp).toLocaleString()}</td>
                                    <td>
                                        <button class="btn btn-warning btn-sm" onclick="editPassengerCount(${passenger.id})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-danger btn-sm ms-1" onclick="deletePassengerCount(${passenger.id})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                            tbody.innerHTML += row;
                        });

                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                        document.getElementById('totalEntered').textContent = totalEntered;
                        document.getElementById('totalExited').textContent = totalExited;
                        document.getElementById('netPassengers').textContent = totalEntered - totalExited;
                        document.getElementById('totalRecords').textContent = data.length;
                    } else {
                        tbody.innerHTML = `<tr><td colspan="7" class="text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–∞—Å—Å–∞–∂–∏—Ä–æ–ø–æ—Ç–æ–∫–µ</td></tr>`;
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                    showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ –ø–∞—Å—Å–∞–∂–∏—Ä–∞—Ö', 'danger');
                });
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –æ –ø–∞—Å—Å–∞–∂–∏—Ä–∞—Ö
        function addPassengerCount() {
            const busId = prompt('ID –∞–≤—Ç–æ–±—É—Å–∞:');
            const stopId = prompt('ID –æ—Å—Ç–∞–Ω–æ–≤–∫–∏:');
            const entered = prompt('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ—à–µ–¥—à–∏—Ö:');
            const exited = prompt('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã—à–µ–¥—à–∏—Ö:');

            if (busId && stopId && entered && exited) {
                const passengerData = {
                    bus: { id: parseInt(busId) },
                    stop: { id: parseInt(stopId) },
                    entered: parseInt(entered),
                    exited: parseInt(exited),
                    timestamp: new Date().toISOString()
                };

                fetch('/api/passengers', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(passengerData)
                })
                .then(response => {
                    if (response.ok) {
                        showAlert('–ó–∞–ø–∏—Å—å –æ –ø–∞—Å—Å–∞–∂–∏—Ä–∞—Ö —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!', 'success');
                        loadPassengerData();
                    } else {
                        throw new Error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è');
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏', 'danger');
                });
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ–≥–Ω–æ–∑–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç–∏
        function getPrediction() {
            const route = document.getElementById('routeSelect').value;
            const time = document.getElementById('predictionTime').value;

            if (!route) {
                showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç', 'warning');
                return;
            }

            // –°–æ–∑–¥–∞–µ–º –ø–æ–ª–Ω—É—é –¥–∞—Ç—É —Å –≤—Ä–µ–º–µ–Ω–µ–º
            const now = new Date();
            const predictionDateTime = new Date(now.toDateString() + ' ' + time);

            fetch(`/api/predictors?route=${route}&time=${predictionDateTime.toISOString()}`)
                .then(response => {
                    if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞');
                    return response.json();
                })
                .then(data => {
                    document.getElementById('predRoute').textContent = `–ú–∞—Ä—à—Ä—É—Ç ${data.route.id}`;
                    document.getElementById('predTime').textContent = time;
                    document.getElementById('predLoad').textContent = data.predictedLoad;

                    const indicator = document.getElementById('loadIndicator');
                    indicator.className = 'load-indicator ';
                    if (data.predictedLoad < 40) {
                        indicator.classList.add('load-low');
                    } else if (data.predictedLoad < 70) {
                        indicator.classList.add('load-medium');
                    } else {
                        indicator.classList.add('load-high');
                    }

                    document.getElementById('predictionResult').classList.remove('d-none');
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ –ø—Ä–æ–≥–Ω–æ–∑–∞', 'danger');
                });
        }

        // –ü–æ–∏—Å–∫ –±–ª–∏–∂–∞–π—à–∏—Ö –æ—Å—Ç–∞–Ω–æ–≤–æ–∫
        function findNearbyStops() {
            const lat = document.getElementById('searchLat').value;
            const lon = document.getElementById('searchLon').value;

            if (!lat || !lon) {
                showAlert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã', 'warning');
                return;
            }

            fetch(`/api/stops/nearby?lat=${lat}&lon=${lon}`)
                .then(response => {
                    if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞');
                    return response.json();
                })
                .then(stops => {
                    const resultsDiv = document.createElement('div');
                    resultsDiv.className = 'mt-3';

                    if (stops.length > 0) {
                        let html = '<h6>–ë–ª–∏–∂–∞–π—à–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏:</h6><div class="list-group">';
                        stops.forEach(stop => {
                            html += `
                                <div class="list-group-item">
                                    <strong>${stop.name}</strong><br>
                                    <small>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${stop.lat.toFixed(4)}, ${stop.lon.toFixed(4)}</small>
                                </div>
                            `;
                        });
                        html += '</div>';
                        resultsDiv.innerHTML = html;
                    } else {
                        resultsDiv.innerHTML = '<div class="alert alert-warning">–û—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —Ä–∞–¥–∏—É—Å–µ 2 –∫–º</div>';
                    }

                    // –í—Å—Ç–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Å–ª–µ —Ñ–æ—Ä–º—ã –ø–æ–∏—Å–∫–∞
                    const searchSection = document.querySelector('#stops .row.mb-4');
                    const existingResults = searchSection.querySelector('.search-results');
                    if (existingResults) existingResults.remove();
                    
                    resultsDiv.className += ' search-results';
                    searchSection.appendChild(resultsDiv);
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫', 'danger');
                });
        }

        // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
        function useCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    document.getElementById('searchLat').value = position.coords.latitude.toFixed(6);
                    document.getElementById('searchLon').value = position.coords.longitude.toFixed(6);
                    showAlert('–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã', 'success');
                }, error => {
                    showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ', 'danger');
                });
            } else {
                showAlert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º', 'warning');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫
        function loadStops() {
            fetch('/api/stops')
                .then(response => {
                    if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                    return response.json();
                })
                .then(stops => {
                    const tbody = document.getElementById('stopsTableBody');
                    tbody.innerHTML = '';

                    if (stops && stops.length > 0) {
                        stops.forEach(stop => {
                            const row = `
                                <tr>
                                    <td>${stop.id}</td>
                                    <td><strong>${stop.name}</strong></td>
                                    <td>${stop.lat}</td>
                                    <td>${stop.lon}</td>
                                    <td>
                                        <button class="btn btn-info btn-sm" onclick="showStopStats(${stop.id})">
                                            <i class="fas fa-chart-bar"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                                        </button>
                                    </td>
                                    <td>
                                        <button class="btn btn-warning btn-sm" onclick="editStop(${stop.id})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </td>
                                </tr>
                            `;
                            tbody.innerHTML += row;
                        });
                    } else {
                        tbody.innerHTML = `<tr><td colspan="6" class="text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –æ—Å—Ç–∞–Ω–æ–≤–∫–∞—Ö</td></tr>`;
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                    showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫', 'danger');
                });
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
        function showStopStats(stopId) {
            fetch(`/api/stops/${stopId}/stats`)
                .then(response => {
                    if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
                    return response.json();
                })
                .then(stats => {
                    alert(`–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏:\n\n` +
                          `–í—Å–µ–≥–æ –≤–æ—à–ª–æ: ${stats.totalEntered}\n` +
                          `–í—Å–µ–≥–æ –≤—ã—à–ª–æ: ${stats.totalExited}\n` +
                          `–ß–∏—Å—Ç—ã–π –ø–æ—Ç–æ–∫: ${stats.netPassengers}`);
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏', 'danger');
                });
        }

        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        window.onload = () => {
            loadPassengerData();
            loadStops();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
            fetch('/api/routes')
                .then(response => response.json())
                .then(routes => {
                    const select = document.getElementById('routeSelect');
                    routes.forEach(route => {
                        const option = document.createElement('option');
                        option.value = route.id;
                        option.textContent = `–ú–∞—Ä—à—Ä—É—Ç ${route.id}`;
                        select.appendChild(option);
                    });
                });
        };
    </script>
</body>
</html>